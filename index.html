<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Treble Clef Note Reading Game</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/3.0.9/vexflow-min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<!-- Import map so bare specifier "pitchy" resolves from jsDelivr ESM -->
<script type="importmap">
{
  "imports": {
    "pitchy": "https://cdn.jsdelivr.net/npm/pitchy@4.1.0/+esm"
  }
}
</script>

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0e0e12;
    --surface: #16161d;
    --surface2: #1e1e28;
    --border: #2a2a38;
    --accent: #c8f564;
    --accent2: #64f5c8;
    --red: #f56464;
    --text: #e8e8f0;
    --muted: #7070a0;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 20% 10%, rgba(100,245,200,0.06) 0%, transparent 60%),
      radial-gradient(ellipse 50% 60% at 80% 90%, rgba(200,245,100,0.05) 0%, transparent 60%);
    pointer-events: none;
  }

  .screen { display: none; width: 100%; max-width: 560px; flex-direction: column; align-items: center; }
  .screen.active { display: flex; }

  .page-title {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(2rem, 5vw, 3rem);
    letter-spacing: -0.02em;
    color: var(--text);
    margin-bottom: 6px;
    text-align: center;
  }
  .page-title span { color: var(--accent); }

  .page-sub {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 36px;
    text-align: center;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 36px;
    width: 100%;
    position: relative;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    border-radius: 20px 20px 0 0;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    opacity: 0.7;
  }

  .btn {
    display: block;
    width: 100%;
    padding: 15px;
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn:hover { opacity: 0.85; }
  .btn:active { transform: scale(0.98); }
  .btn:disabled { opacity: 0.35; cursor: default; }

  .btn-primary { background: var(--accent); color: #0e0e12; }
  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); opacity: 1; }
  .btn-gap { margin-top: 12px; }

  .home-buttons { display: flex; flex-direction: column; gap: 14px; width: 100%; }

  .mode-btn {
    padding: 22px 24px;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .mode-btn .btn-title {
    font-size: 1rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    color: #0e0e12;
  }
  .mode-btn .btn-desc {
    font-size: 0.68rem;
    letter-spacing: 0.06em;
    color: rgba(14,14,18,0.6);
    text-transform: none;
  }

  .level-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }

  .level-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 16px;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.1s;
    text-align: center;
  }
  .level-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .level-card:active { transform: scale(0.97); }

  .level-num {
    font-family: 'DM Serif Display', serif;
    font-size: 2.2rem;
    color: var(--accent);
    display: block;
    line-height: 1;
    margin-bottom: 6px;
  }
  .level-goal {
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    line-height: 1.5;
  }

  .back-link {
    margin-top: 20px;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    background: none;
    border: none;
    font-family: 'DM Mono', monospace;
    transition: color 0.2s;
  }
  .back-link:hover { color: var(--accent); }

  #staff-wrap {
    background: #f9f9f4;
    border-radius: 12px;
    padding: 12px 0 8px;
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 140px;
    position: relative;
    transition: background 0.25s;
    width: 100%;
    overflow: hidden;
  }
  #staff-wrap.correct { background: #effff2; }
  #staff-wrap.wrong   { background: #fff2f2; }
  #staff-svg { display: block; }

  .status-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .mic-dot {
    width: 9px; height: 9px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
    transition: background 0.2s, box-shadow 0.2s;
  }
  .mic-dot.active {
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
    animation: blink 1.4s infinite;
  }
  .mic-dot.error { background: var(--red); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.35} }

  #status-text { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.04em; flex: 1; }
  #detected-note { font-size: 0.82rem; color: var(--accent2); min-width: 56px; text-align: right; }

  .conf-bar-wrap {
    height: 2px; background: var(--border);
    border-radius: 2px; margin-bottom: 18px; overflow: hidden;
  }
  .conf-bar {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 2px; transition: width 0.08s;
  }

  #feedback {
    text-align: center;
    font-family: 'DM Serif Display', serif;
    font-size: 1.6rem;
    height: 40px;
    margin-bottom: 18px;
    letter-spacing: -0.01em;
    transition: color 0.2s;
  }
  #feedback.correct { color: var(--accent); }
  #feedback.wrong   { color: var(--red); }

  .score-row { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 18px; }
  .score-box {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 8px;
    text-align: center;
  }
  .score-val { font-size: 1.4rem; font-weight: 500; color: var(--text); display: block; }
  .score-val.green { color: var(--accent); }
  .score-val.red   { color: var(--red); }
  .score-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; margin-top: 2px; display: block; }

  #timer-wrap { margin-bottom: 14px; display: none; }
  #timer-label { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 5px; }
  #timer-bar-bg { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
  #timer-bar { height: 100%; width: 100%; background: linear-gradient(90deg, var(--accent2), var(--accent)); border-radius: 3px; transition: width 0.1s linear; }
  #timer-bar.urgent { background: linear-gradient(90deg, var(--red), #ff9966); }

  .end-icon { font-size: 3.5rem; margin-bottom: 12px; }
  .end-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.9rem;
    letter-spacing: -0.02em;
    margin-bottom: 10px;
    text-align: center;
  }
  .end-title.win  { color: var(--accent); }
  .end-title.lose { color: var(--red); }
  .end-sub { font-size: 0.75rem; color: var(--muted); letter-spacing: 0.06em; margin-bottom: 28px; text-align: center; line-height: 1.7; }
</style>
</head>
<body>

<!-- HOME SCREEN -->
<div id="screen-home" class="screen active">
  <h1 class="page-title">Treble Clef Note Reading Game</h1>
  <div class="card">
    <div class="home-buttons">
      <button class="btn btn-primary mode-btn" onclick="goLevelSelect('spaces')">
        <span class="btn-title">Treble Clef Spaces</span>
      </button>
      <button class="btn btn-primary mode-btn" onclick="goLevelSelect('lines')">
        <span class="btn-title">Treble Clef Lines</span>
      </button>
    </div>
  </div>
</div>

<!-- LEVEL SELECT SCREEN -->
<div id="screen-levels" class="screen">
  <h1 class="page-title" id="level-screen-title">Spaces</h1>
  <p class="page-sub" id="level-screen-sub">Choose a level</p>
  <div class="card">
    <div class="level-grid">
      <div class="level-card" onclick="startGame(1)">
        <span class="level-num">1</span>
        <span class="level-goal">5 correct<br>in a row</span>
      </div>
      <div class="level-card" onclick="startGame(2)">
        <span class="level-num">2</span>
        <span class="level-goal">10 correct<br>in a row</span>
      </div>
      <div class="level-card" onclick="startGame(3)">
        <span class="level-num">3</span>
        <span class="level-goal">20 correct<br>in a row</span>
      </div>
      <div class="level-card" onclick="startGame(4)">
        <span class="level-num">4</span>
        <span class="level-goal">20 correct<br>under 40 sec</span>
      </div>
    </div>
  </div>
  <button class="back-link" onclick="goHome()">‚Üê Back</button>
</div>

<!-- GAME SCREEN -->
<div id="screen-game" class="screen">
  <h1 class="page-title" id="game-title">Level <span id="game-level-num">1</span></h1>
  <p class="page-sub" id="game-goal-sub"></p>
  <div class="card">
    <div id="staff-wrap">
      <div id="staff-svg"></div>
    </div>

    <div class="status-row">
      <div class="mic-dot" id="mic-dot"></div>
      <span id="status-text">Starting‚Ä¶</span>

    </div>
    <div class="conf-bar-wrap"><div class="conf-bar" id="conf-bar"></div></div>

    <div id="feedback">&nbsp;</div>

    <div id="timer-wrap">
      <div id="timer-label">Time remaining ‚Äî <span id="timer-secs">40</span>s</div>
      <div id="timer-bar-bg"><div id="timer-bar"></div></div>
    </div>

    <div class="score-row">
      <div class="score-box">
        <span class="score-val green" id="sc-correct">0</span>
        <span class="score-label" id="sc-correct-label">Correct</span>
      </div>
      <div class="score-box">
        <span class="score-val" id="sc-streak">0</span>
        <span class="score-label" id="sc-streak-label">Streak</span>
      </div>
      <div class="score-box">
        <span class="score-val red" id="sc-wrong">0</span>
        <span class="score-label">Wrong</span>
      </div>
    </div>

    <button class="btn btn-secondary" onclick="quitGame()">Quit Level</button>
  </div>
</div>

<!-- WIN SCREEN -->
<div id="screen-win" class="screen">
  <div class="card" style="text-align:center">
    <div class="end-icon">üéâ</div>
    <div class="end-title win" id="win-title">Congratulations!</div>
    <div class="end-sub" id="win-sub"></div>
    <button class="btn btn-primary" onclick="playAnotherLevel()">Play Another Level</button>
    <button class="btn btn-secondary btn-gap" onclick="goHome()">Home</button>
  </div>
</div>

<!-- LOSE SCREEN -->
<div id="screen-lose" class="screen">
  <div class="card" style="text-align:center">
    <div class="end-icon">üòî</div>
    <div class="end-title lose">Not quite!</div>
    <div class="end-sub" id="lose-sub"></div>
    <button class="btn btn-primary" onclick="retryGame()">Try Again</button>
    <button class="btn btn-secondary btn-gap" onclick="goLevelSelect(currentMode)">Choose Level</button>
    <button class="btn btn-secondary btn-gap" onclick="goHome()">Home</button>
  </div>
</div>

<!-- All game logic as an ES module so we can import Pitchy -->
<script type="module">
import { PitchDetector } from 'pitchy';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTE POOLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SPACES_NOTES = [
  { vex:'f/4', name:'F4', midi:65, acc:null },
  { vex:'a/4', name:'A4', midi:69, acc:null },
  { vex:'c/5', name:'C5', midi:72, acc:null },
  { vex:'e/5', name:'E5', midi:76, acc:null },
];
const LINES_NOTES = [
  { vex:'e/4', name:'E4', midi:64, acc:null },
  { vex:'g/4', name:'G4', midi:67, acc:null },
  { vex:'b/4', name:'B4', midi:71, acc:null },
  { vex:'d/5', name:'D5', midi:74, acc:null },
  { vex:'f/5', name:'F5', midi:77, acc:null },
];

const LEVELS = [
  null,
  { streakGoal: 5,  totalGoal: 0,  timeLimit: 0  },
  { streakGoal: 10, totalGoal: 0,  timeLimit: 0  },
  { streakGoal: 20, totalGoal: 0,  timeLimit: 0  },
  { streakGoal: 0,  totalGoal: 20, timeLimit: 40 },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VexFlow helpers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const VF = (typeof Vex !== 'undefined' && Vex.Flow)
  ? Vex.Flow
  : (typeof VexFlow !== 'undefined' ? VexFlow : null);

function renderNote(noteObj) {
  const container = document.getElementById('staff-svg');
  container.innerHTML = '';
  const wrap = document.getElementById('staff-wrap');
  const W = Math.min(400, wrap.clientWidth - 16);
  const H = 140;
  const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
  renderer.resize(W, H);
  const ctx = renderer.getContext();
  const scale = W / 400;
  const staveX = Math.round(10 * scale);
  const staveY = 20;
  const staveW = W - staveX * 2;
  const stave = new VF.Stave(staveX, staveY, staveW);
  stave.addClef('treble');
  stave.setContext(ctx).draw();
  const sn = new VF.StaveNote({ clef:'treble', keys:[noteObj.vex], duration:'q' });
  if (noteObj.acc === '#') sn.addAccidental(0, new VF.Accidental('#'));
  else if (noteObj.acc === 'b') sn.addAccidental(0, new VF.Accidental('b'));
  const voice = new VF.Voice({ num_beats:1, beat_value:4 });
  voice.setStrict(false);
  voice.addTickables([sn]);
  new VF.Formatter().joinVoices([voice]).format([voice], staveW - Math.round(80 * scale));
  voice.draw(ctx, stave);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Pitch helpers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freqToMidi(freq) {
  return Math.round(12 * Math.log2(freq / 440) + 69);
}
function midiToName(midi) {
  const names = ['C','C‚ôØ','D','D‚ôØ','E','F','F‚ôØ','G','G‚ôØ','A','A‚ôØ','B'];
  return names[midi % 12] + (Math.floor(midi / 12) - 1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// App state
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentMode  = 'spaces';
let currentLevel = 1;
let notePool     = [];
let currentNote  = null;

let correctCount = 0;
let wrongCount   = 0;
let streakCount  = 0;

// Audio
let listening   = false;
let audioCtx    = null;
let analyser    = null;
let micStream   = null;
let rafId       = null;
let detector    = null;   // Pitchy PitchDetector instance
let inputBuf    = null;   // Float32Array sized to detector.inputLength

// Stability gate ‚Äî same as before
let cooldown    = false;
let lastMidi    = -1;
let stableCount = 0;
const STABLE_NEEDED = 6;  // slightly higher threshold for MPM's speed

// Clarity threshold ‚Äî MPM's "clarity" replaces the old cents-based confidence.
// Piano tones: 0.85+ is very reliable; lower catches quieter or softer attacks.
const CLARITY_THRESHOLD = 0.82;

// Timer
let timerInterval  = null;
let timerSecsLeft  = 40;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Screen navigation ‚Äî exposed on window for inline onclick
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

window.goHome = function() {
  stopAudio();
  stopTimer();
  showScreen('screen-home');
};

window.goLevelSelect = function(mode) {
  stopAudio();
  stopTimer();
  currentMode = mode;
  const isSpaces = mode === 'spaces';
  document.getElementById('level-screen-title').innerHTML =
    'Treble Clef <span style="color:var(--accent)">' + (isSpaces ? 'Spaces' : 'Lines') + '</span>';
  showScreen('screen-levels');
};

window.startGame = async function(level) {
  currentLevel = level;
  notePool = currentMode === 'spaces' ? SPACES_NOTES : LINES_NOTES;
  correctCount = 0; wrongCount = 0; streakCount = 0;
  currentNote  = null;
  cooldown     = false; lastMidi = -1; stableCount = 0;

  document.getElementById('game-level-num').textContent = level;
  const def = LEVELS[level];

  const goalText =
    level === 4 ? 'Get 20 correct in 40 seconds' :
    level === 1 ? 'Get 5 correct in a row' :
    level === 2 ? 'Get 10 correct in a row' :
                  'Get 20 correct in a row';
  document.getElementById('game-goal-sub').textContent = goalText;

  if (def.streakGoal > 0) {
    document.getElementById('sc-streak-label').textContent = `Streak / ${def.streakGoal}`;
    document.getElementById('sc-correct-label').textContent = 'Correct';
  } else {
    document.getElementById('sc-streak-label').textContent = 'Streak';
    document.getElementById('sc-correct-label').textContent = `Correct / ${def.totalGoal}`;
  }

  updateScoreDisplay();
  document.getElementById('feedback').innerHTML = '&nbsp;';
  document.getElementById('feedback').className = '';

  const timerWrap = document.getElementById('timer-wrap');
  if (def.timeLimit > 0) {
    timerWrap.style.display = 'block';
    timerSecsLeft = def.timeLimit;
    document.getElementById('timer-secs').textContent = timerSecsLeft;
    document.getElementById('timer-bar').style.width = '100%';
    document.getElementById('timer-bar').classList.remove('urgent');
  } else {
    timerWrap.style.display = 'none';
  }

  showScreen('screen-game');

  await initAudio();
  if (!listening) return;

  pickAndShowNote();
  audioLoop();

  if (def.timeLimit > 0) startTimer(def.timeLimit);
};

window.retryGame       = () => window.startGame(currentLevel);
window.quitGame        = () => { stopAudio(); stopTimer(); window.goLevelSelect(currentMode); };
window.playAnotherLevel = () => window.goLevelSelect(currentMode);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Audio init / teardown
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initAudio() {
  stopAudio();
  document.getElementById('mic-dot').className = 'mic-dot';
  document.getElementById('status-text').textContent = 'Requesting microphone‚Ä¶';

  try {
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
    });
  } catch(e) {
    document.getElementById('status-text').textContent = 'Mic access denied ‚Äî please allow microphone.';
    document.getElementById('mic-dot').className = 'mic-dot error';
    return;
  }

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();

  // fftSize must be large enough to resolve low piano notes.
  // E4 = 330 Hz ‚Üí at 44100 Hz SR, need at least ~134 samples per period.
  // 4096 gives ~11ms of data at 44100 ‚Äî plenty for MPM.
  analyser.fftSize = 4096;
  analyser.smoothingTimeConstant = 0.0; // MPM doesn't benefit from spectral smoothing

  audioCtx.createMediaStreamSource(micStream).connect(analyser);

  // Build detector sized exactly to fftSize.
  // PitchDetector.forFloat32Array(inputLength) ‚Üí inputLength == fftSize
  detector = PitchDetector.forFloat32Array(analyser.fftSize);
  inputBuf  = new Float32Array(detector.inputLength);

  listening = true;
  document.getElementById('mic-dot').className = 'mic-dot active';
  document.getElementById('status-text').textContent = 'Listening ‚Äî play the note shown';
}

function stopAudio() {
  listening = false;
  cancelAnimationFrame(rafId);
  if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
  if (audioCtx)  { audioCtx.close(); audioCtx = null; }
  detector = null;
  inputBuf = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Timer
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer(secs) {
  stopTimer();
  timerSecsLeft = secs;
  const bar   = document.getElementById('timer-bar');
  const label = document.getElementById('timer-secs');
  const total = secs;

  timerInterval = setInterval(() => {
    timerSecsLeft--;
    label.textContent = timerSecsLeft;
    bar.style.width = ((timerSecsLeft / total) * 100) + '%';
    if (timerSecsLeft <= 10) bar.classList.add('urgent');
    if (timerSecsLeft <= 0)  { stopTimer(); endLevel(false); }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Game logic
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pickAndShowNote() {
  let n, tries = 0;
  do {
    n = notePool[Math.floor(Math.random() * notePool.length)];
    tries++;
  } while (currentNote && n.midi === currentNote.midi && tries < 20);
  currentNote = n;
  renderNote(currentNote);
  document.getElementById('feedback').innerHTML = '&nbsp;';
  document.getElementById('feedback').className = '';
  lastMidi = -1; stableCount = 0; cooldown = false;
}

function updateScoreDisplay() {
  document.getElementById('sc-correct').textContent = correctCount;
  document.getElementById('sc-streak').textContent  = streakCount;
  document.getElementById('sc-wrong').textContent   = wrongCount;
}

function flash(text, cls) {
  const fb = document.getElementById('feedback');
  fb.textContent = text;
  fb.className = cls;
  const wrap = document.getElementById('staff-wrap');
  wrap.classList.add(cls);
  setTimeout(() => wrap.classList.remove(cls), 450);
}

function checkWinCondition() {
  const def = LEVELS[currentLevel];
  if (def.streakGoal > 0 && streakCount  >= def.streakGoal) return true;
  if (def.totalGoal  > 0 && correctCount >= def.totalGoal)  return true;
  return false;
}

function endLevel(won) {
  stopAudio();
  stopTimer();
  if (won) {
    document.getElementById('win-title').textContent = `Congratulations, you completed Level ${currentLevel}!`;
    const def = LEVELS[currentLevel];
    const detail = currentLevel === 4
      ? `20 notes correct in ${40 - timerSecsLeft} seconds with ${wrongCount} mistake${wrongCount !== 1 ? 's' : ''}.`
      : `You hit a streak of ${def.streakGoal} with ${wrongCount} mistake${wrongCount !== 1 ? 's' : ''}.`;
    document.getElementById('win-sub').textContent = detail;
    showScreen('screen-win');
  } else {
    const def = LEVELS[currentLevel];
    const detail = currentLevel === 4
      ? `You got ${correctCount} / 20 correct before time ran out.`
      : `Your best streak was ${streakCount}. Goal: ${def.streakGoal} in a row.`;
    document.getElementById('lose-sub').textContent = detail;
    showScreen('screen-lose');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Audio loop ‚Äî now using Pitchy / MPM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function audioLoop() {
  if (!listening) return;
  rafId = requestAnimationFrame(audioLoop);

  // Fill inputBuf from the analyser ‚Äî must match detector.inputLength exactly
  analyser.getFloatTimeDomainData(inputBuf);

  // findPitch returns [pitchHz, clarity].
  // clarity is 0‚Äì1; MPM produces 1.0 for a clean sine, ~0.9+ for clean piano.
  const [pitch, clarity] = detector.findPitch(inputBuf, audioCtx.sampleRate);

  const confBar = document.getElementById('conf-bar');

  // Below threshold ‚Üí treat as silence / noise
  if (clarity < CLARITY_THRESHOLD || pitch < 20) {
    confBar.style.width = '0%';
    lastMidi    = -1;
    stableCount = 0;
    return;
  }

  const midi = freqToMidi(pitch);

  // Map clarity (0.82‚Äì1.0 useful range) ‚Üí 0‚Äì100% bar width
  const barPct = Math.min(100, ((clarity - CLARITY_THRESHOLD) / (1 - CLARITY_THRESHOLD)) * 100);
  confBar.style.width = barPct.toFixed(0) + '%';

  // Stability gate: require STABLE_NEEDED consecutive frames on the same MIDI note
  if (midi === lastMidi) {
    stableCount++;
  } else {
    lastMidi    = midi;
    stableCount = 1;
  }

  if (stableCount >= STABLE_NEEDED && !cooldown && currentNote) {
    cooldown    = true;
    stableCount = 0;

    if (midi === currentNote.midi) {
      correctCount++;
      streakCount++;
      updateScoreDisplay();
      flash('‚úì Correct!', 'correct');

      if (checkWinCondition()) {
        setTimeout(() => endLevel(true), 600);
      } else {
        setTimeout(pickAndShowNote, 700);
      }
    } else {
      wrongCount++;
      if (LEVELS[currentLevel].streakGoal > 0) streakCount = 0;
      updateScoreDisplay();
      flash(`‚úó That was ${midiToName(midi)}`, 'wrong');
      setTimeout(() => { cooldown = false; }, 1100);
    }
  }
}

// Re-render on resize
window.addEventListener('resize', () => {
  if (currentNote) renderNote(currentNote);
});
</script>
</body>
</html>
